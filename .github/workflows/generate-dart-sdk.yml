name: Generate Dart SDK

on:
  workflow_dispatch:
  push:
    branches:
      - develop

jobs:
  generate-sdk:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Clone NestJS API repo (orion_gem_nest_api)
        uses: actions/checkout@v4
        with:
          repository: joicodev/orion_gem_nest_api
          path: backend

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 📦 Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: 🚀 Run NestJS API in background
        working-directory: backend
        run: |
          npm run start:dev &
          echo "⏳ Waiting for API to be ready..."
          for i in {1..30}; do
            if curl -s --fail http://localhost:3000/api-json > /dev/null; then
              echo "✅ API is up!"
              break
            elif [ $i -eq 30 ]; then
              echo "❌ API did not start in time."
              exit 1
            fi
            sleep 2
          done

      - name: ⬇️ Clone Dart SDK repo (orion_gem_dart_client)
        uses: actions/checkout@v4
        with:
          repository: joicodev/orion_gem_dart_client
          path: dart_sdk
          token: ${{ secrets.PAT_TOKEN }}

      - name: 🐦 Setup Flutter (includes Dart)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'

      - name: ⚙️ Run client_generator.sh
        working-directory: dart_sdk
        run: |
          chmod +x client_generator.sh
          ./client_generator.sh

      - name: 🆕 Create SDK branch and commit
        working-directory: dart_sdk
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}' || echo "1.0.0")
          BRANCH_NAME="auto/sdk-update-v$VERSION"
          git checkout -B "$BRANCH_NAME"
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "🔄 Auto SDK update (v$VERSION)"
            git push origin "$BRANCH_NAME" --force

      - name: 🚀 Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          path: dart_sdk
          commit-message: "chore(sdk): Auto-generated Dart client"
          committer: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          branch: auto/sdk-update
          base: main
          delete-branch: true
          title: "🤖 SDK: Auto-generated Dart client update"
          body: |
            This PR contains the auto-generated Dart client for Orion GEM API.
            <sub>Generated by GitHub Actions 🤖</sub>
          labels: |
            sdk
            auto-generated
